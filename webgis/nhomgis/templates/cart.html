{% extends 'layout.html' %}
{% load humanize %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<div class="container mt-4">
    <h3 class="mb-4"><i class="bi bi-cart3"></i> Thanh toán đơn hàng</h3>

    <div class="row">
        <div class="col-md-7">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    {% if cart_items %}
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>Đơn giá</th>
                                    <th>SL</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ item.product.image_url }}" width="40" class="rounded me-2">
                                            <span class="small fw-bold">{{ item.product.name }}</span>
                                        </div>
                                    </td>
                                    <td>{{ item.product.price|intcomma }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td class="fw-bold">{{ item.total|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-center">Giỏ hàng trống.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow border-0 bg-light">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="bi bi-geo-alt"></i> Thông tin giao hàng
                </div>
                <div class="card-body">
                    {% if cart_items %}
                        <form action="{% url 'checkout' %}" method="POST" id="checkoutForm">
                            {% csrf_token %}
                            
                            <div class="mb-2">
                                <label class="fw-bold small">Người nhận:</label> {{ request.user.username }}
                            </div>

                            <div class="mb-2">
                                <label class="form-label fw-bold small">Địa chỉ giao hàng</label>
                                <textarea name="address" id="address" class="form-control" rows="2" required placeholder="Chọn trên bản đồ..."></textarea>
                            </div>

                            <div class="mb-3 border rounded p-1 bg-white">
                                <div id="map" style="height: 250px; width: 100%;"></div>
                                <small class="text-muted fst-italic" style="font-size: 0.8rem;">
                                    * Kéo ghim đỏ để tính phí vận chuyển chính xác.
                                </small>
                            </div>

                            <div class="bg-white p-3 rounded border mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Tiền hàng:</span>
                                    <span class="fw-bold">{{ total_price|intcomma }} đ</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1 text-primary">
                                    <span>+ Phí vận chuyển:</span>
                                    <span class="fw-bold" id="ui_ship_fee">0 đ</span>
                                </div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-between fs-5 fw-bold text-danger">
                                    <span>TỔNG CỘNG:</span>
                                    <span id="ui_grand_total">{{ total_price|intcomma }} đ</span>
                                </div>
                            </div>

                            <input type="hidden" name="lat" id="lat">
                            <input type="hidden" name="lon" id="lon">
                            <input type="hidden" name="shipping_fee" id="shipping_fee" value="0">

                            <button type="submit" class="btn btn-success w-100 py-2 fw-bold">
                                HOÀN TẤT ĐẶT HÀNG
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Lấy tổng tiền hàng từ Server render ra (dạng số nguyên)
    var productTotal = {{ total_price|stringformat:"d" }};

    var map = L.map('map').setView([10.8231, 106.6297], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var marker = L.marker(map.getCenter(), {draggable: true, autoPan: true}).addTo(map);

    // Hàm gọi API tính phí ship
    function calculateShipping(lat, lng) {
        // Cập nhật input ẩn tọa độ
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lng;

        // Gọi API Backend
        const formData = new FormData();
        formData.append('lat', lat);
        formData.append('lng', lng);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); // Quan trọng!

        fetch('/api/calculate-shipping/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                var fee = data.fee;
                
                // 1. Cập nhật hiển thị Phí Ship
                document.getElementById('ui_ship_fee').innerText = fee.toLocaleString() + ' đ';
                document.getElementById('shipping_fee').value = fee; // Gán vào input ẩn

                // 2. Cập nhật Tổng tiền (Hàng + Ship)
                var grandTotal = productTotal + fee;
                document.getElementById('ui_grand_total').innerText = grandTotal.toLocaleString() + ' đ';

                // 3. Cập nhật tên địa chỉ (Reverse Geo)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                    .then(res => res.json())
                    .then(geo => {
                        if(geo.display_name) document.getElementById('address').value = geo.display_name;
                    });
            } else {
                alert("Lỗi tính phí: " + data.error);
            }
        })
        .catch(err => console.error(err));
    }

    // Sự kiện kéo ghim
    marker.on('dragend', function(e) {
        var coord = e.target.getLatLng();
        calculateShipping(coord.lat, coord.lng);
    });

    // Sự kiện click bản đồ
    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        calculateShipping(e.latlng.lat, e.latlng.lng);
    });

    // Sự kiện tìm kiếm địa chỉ
    L.Control.geocoder({defaultMarkGeocode: false})
    .on('markgeocode', function(e) {
        var center = e.geocode.center;
        map.setView(center, 16);
        marker.setLatLng(center);
        calculateShipping(center.lat, center.lng);
    })
    .addTo(map);

    // Khởi chạy lần đầu
    var init = map.getCenter();
    calculateShipping(init.lat, init.lng);
</script>
{% endblock %}